<style>
    .form-label {
  font-size: 16px;
}

.border-dashed {
  border-style: dashed !important;
}

.form-control,
.form-select {
  border-radius: 10px;
  padding: 10px 14px;
}

.bg-white {
  border-radius: 12px !important;
}

.variant-error {
    color: red;
    font-size: 12px;
    margin-top: -6px;
    margin-bottom: 8px;
}
.image-thumbnail-wrapper {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
}

.image-thumbnail-wrapper img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  transition: transform 0.2s;
  cursor: pointer;
}

.image-thumbnail-wrapper:hover img {
  transform: scale(1.05);
}

.thumbnail-actions {
  position: absolute;
  top: 5px;
  right: 5px;
  display: flex;
  gap: 5px;
}

.thumbnail-actions button {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  opacity: 0.9;
}

.thumbnail-actions button:hover {
  opacity: 1;
}

.image-number {
  position: absolute;
  bottom: 5px;
  left: 5px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}
</style>
<%- include('../../views/partials/admin/header.ejs') %>

<form action="/admin/products/edit/<%= product._id %>"  enctype="multipart/form-data" id="editProduct">
  <input type="hidden" name="_method" value="PUT">
  <!-- PAGE HEADER -->
  <div class="d-flex align-items-center mb-4 py-2 px-4">
   
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="fw-semibold mb-1">Update Product</h4>
        <p class="text-muted mb-0" style="font-size: 1.2rem;">
          edit product
        </p>
      </div>
      </div>
    <button type="submit" class="btn  ms-auto px-4" style="background-color:#b8c9ae; border:none;" onclick="validateForm()">
      <i class="bi bi-check2-circle me-1"></i> Save Product
    </button>
  </div>


  <div class="row py-2 px-4">

    <!-- LEFT SECTION -->
    <div class="col-lg-8 ">

      <!-- BASIC INFORMATION -->
      <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
        <h5 class="fw-semibold mb-3">Basic Information</h5>

        <!-- Product Name -->
        <div class="mb-3">
          <label class="form-label fw-medium">Product Name <span class="text-danger">*</span></label>
          <input type="text" name="productName" class="form-control"
       value="<%= product.productName %>">
          <div id="error-productName" class="text-danger small"></div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label fw-medium">Description <span class="text-danger">*</span></label>
          <textarea name="description" class="form-control"><%= product.description %></textarea>
            <div id="error-description" class="text-danger small"></div>
        </div>

        <!-- Category + SKU -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-medium">Category <span class="text-danger">*</span></label>
            <select name="category" class="form-select" >
               
                <% cat.forEach(c => { %>
                <option value="<%= c.name %>"
                <%= c._id.toString() === product.category._id.toString() ? 'selected' : '' %>>
                <%= c.name %>
                </option>
                 <% }) %>
            </select>
             <div id="error-category" class="text-danger small"></div>
          </div>
        </div>

      </div>

      <!-- PRICING & INVENTORY -->
<div class="bg-white p-4 rounded-3 shadow-sm mb-4">
  <h5 class="fw-semibold mb-3">Pricing and Inventory</h5>
  
  <div id="variantContainer">
    <!-- First variant row -->
    <div class="variant-row mb-3">
        <% product.variants.forEach(v => { %>
      <div class="d-flex gap-3 align-items-start">
        <div class="flex-fill">
          <input type="text" name="variantName[]" value="<%= v.size %>">
          <div class="variant-error text-danger small"></div>
        </div>
        <div class="flex-fill">
          <input type="number" name="variantPrice[]" value="<%= v.regular_price %>">
          <div class="variant-error text-danger small"></div>
        </div>
        <div class="flex-fill">
           <input type="number" name="variantStock[]" value="<%= v.quantity %>">
          <div class="variant-error text-danger small"></div>
        </div>
        <button type="button" class="btn btn-light border removeVariant" style="min-width: 40px;">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <%})%>
    </div>
  </div>

  <div id="variant-main-error" class="text-danger small mb-2"></div>

  <button type="button" id="addVariantBtn" class="btn btn-outline-secondary rounded-pill mt-2">
    <i class="bi bi-plus-lg me-1"></i> Add Variant
  </button>
</div>
    </div>


    <!-- RIGHT SECTION -->
    <div class="col-lg-4">

      <!-- VISIBILITY -->
      <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
        <h5 class="fw-semibold mb-3">Product Visibility</h5>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-medium">Featured Product</span>
          <div class="form-check form-switch">
            <input class="form-check-input" name="featured" type="checkbox">
          </div>
        </div>

        <label class="fw-medium">Product Status</label>
        <select name="status" class="form-select">
          <option value="Listed">Listed</option>
          <option value="Unlisted">Unlisted</option>
        </select>
      </div>

  
<!-- PRODUCT IMAGES -->
<div class="bg-white p-4 rounded-3 shadow-sm mb-4">
  <h5 class="fw-semibold mb-3">Product Images</h5>
  <p class="text-muted small mb-3">
    <i class="bi bi-info-circle me-1"></i>
    Exactly 3 images required. Check the box to remove an image, then upload new ones.
  </p>

  <div class="border border-2 border-dashed rounded-3 p-4 text-center mb-3" id="uploadArea">
    <i class="bi bi-upload fs-2 text-muted"></i>
    <p class="mb-0 mt-2 text-muted">Click to upload <br> or drag and drop</p>
    <small class="text-muted">PNG, JPG, JPEG (MAX. 2MB per image)</small>

    <input type="file"
           name="images[]"
           id="productImages"
           class="form-control mt-3"
           multiple
           accept="image/png, image/jpeg, image/jpg">
  </div>
  
  <!-- Image Thumbnails Container -->
  <div id="imageThumbnails" class="row g-3">
    <% product.images.forEach((img, index) => { %>
    <div class="col-3">
      <div class="position-relative">
        <img src="<%= img %>" class="img-fluid rounded" style="height: 120px; object-fit: cover; width: 100%;">
        <div class="position-absolute bottom-0 start-0 w-100 p-2" style="background: rgba(0,0,0,0.6);">
          <label class="text-white d-flex align-items-center mb-0" style="cursor: pointer; font-size: 12px;">
            <input type="checkbox" name="removeImages[]" value="<%= img %>" class="me-2">
            Remove this image
          </label>
        </div>
        <span class="badge bg-primary position-absolute top-0 start-0 m-1">Existing</span>
      </div>
    </div>
    <% }); %>
  </div>
  
  <div id="imageError" class="text-danger small mt-2"></div>
  <div id="imageCount" class="text-muted small mt-2 fw-semibold"></div>
</div>
    </div>

  </div>

</form>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
// Edit Product Form - Exactly 3 Images Required
let selectedImages = [];
let cropper = null;

document.addEventListener('DOMContentLoaded', function() {
    updateImageCount();

    // Prevent default form submission
    document.getElementById('editProduct').addEventListener('submit', function(e) {
        e.preventDefault();
        validateForm();
    });

    // Add Variant Button Handler
    document.getElementById('addVariantBtn').addEventListener('click', function() {
        const container = document.getElementById('variantContainer');
        const variantRow = container.querySelector('.variant-row');
        
        const newVariant = document.createElement('div');
        newVariant.className = 'mb-3';
        newVariant.innerHTML = `
            <div class="d-flex gap-3 align-items-start">
                <div class="flex-fill">
                    <input type="text" name="variantName[]" class="form-control" placeholder="Size (e.g., 50ml)">
                    <div class="variant-error text-danger small"></div>
                </div>
                <div class="flex-fill">
                    <input type="number" name="variantPrice[]" step="0.01" class="form-control" placeholder="Price ($)">
                    <div class="variant-error text-danger small"></div>
                </div>
                <div class="flex-fill">
                    <input type="number" name="variantStock[]" class="form-control" placeholder="Stock">
                    <div class="variant-error text-danger small"></div>
                </div>
                <button type="button" class="btn btn-light border removeVariant" style="min-width: 40px;">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        `;
        variantRow.appendChild(newVariant);
    });

    // Remove Variant Handler
    document.getElementById('variantContainer').addEventListener('click', function(e) {
        if (e.target.closest('.removeVariant')) {
            const allVariants = document.querySelectorAll('#variantContainer .d-flex.gap-3');
            if (allVariants.length > 1) {
                e.target.closest('.mb-3').remove();
            } else {
                showError('variant-main-error', 'At least one variant is required');
                setTimeout(() => clearError('variant-main-error'), 3000);
            }
        }
    });

    // Track removed existing images
    document.getElementById('imageThumbnails').addEventListener('change', function(e) {
        if (e.target.name === 'removeImages[]') {
            updateImageCount();
        }
    });

    // New Image Upload Handler
    const imageInput = document.getElementById('productImages');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            handleImageSelection(e.target.files);
            e.target.value = '';
        });
    }
});

// Handle new image selection
function handleImageSelection(files) {
    if (files.length === 0) return;

    // Calculate current total
    const remainingExisting = getRemainingExistingImagesCount();
    const currentTotal = remainingExisting + selectedImages.length;
    const availableSlots = 3 - currentTotal;

    if (availableSlots <= 0) {
        showError('imageError', 'Maximum 3 images allowed. Remove existing images first.');
        return;
    }

    // Limit files to available slots
    const filesToAdd = Math.min(files.length, availableSlots);
    
    if (files.length > availableSlots) {
        showError('imageError', `Only ${availableSlots} more image(s) can be added. Maximum 3 images allowed.`);
        setTimeout(() => clearError('imageError'), 4000);
    }

    // Validate and add files
    for (let i = 0; i < filesToAdd; i++) {
        const file = files[i];
        
        // File type validation
        if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/jpg')) {
            showError('imageError', 'Only PNG, JPG, JPEG files are allowed');
            return;
        }
        
        // File size validation (2MB)
        if (file.size > 2 * 1024 * 1024) {
            showError('imageError', 'Each image must be less than 2MB');
            return;
        }
        
        selectedImages.push(file);
    }

    displayNewImageThumbnails();
    updateImageCount();
}

// Get count of existing images that are NOT marked for removal
function getRemainingExistingImagesCount() {
    const totalExisting = document.querySelectorAll('#imageThumbnails > div:not([data-new-image])').length;
    const markedForRemoval = document.querySelectorAll('[name="removeImages[]"]:checked').length;
    return totalExisting - markedForRemoval;
}

// Display thumbnails for newly uploaded images
function displayNewImageThumbnails() {
    // Remove previous new image thumbnails
    document.querySelectorAll('[data-new-image]').forEach(el => el.remove());
    
    const container = document.getElementById('imageThumbnails');
    
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const col = document.createElement('div');
            col.className = 'col-3';
            col.setAttribute('data-new-image', index);
            col.innerHTML = `
                <div class="position-relative">
                    <img src="${e.target.result}" class="img-fluid rounded" style="height: 120px; object-fit: cover; width: 100%;">
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-new-image" data-index="${index}" title="Remove">
                        <i class="bi bi-x"></i>
                    </button>
                    <span class="badge bg-success position-absolute bottom-0 start-0 m-1">New</span>
                </div>
            `;
            container.appendChild(col);
        };
        reader.readAsDataURL(file);
    });

    // Attach remove handlers for new images
    setTimeout(() => {
        document.querySelectorAll('.remove-new-image').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                selectedImages.splice(index, 1);
                displayNewImageThumbnails();
                updateImageCount();
            });
        });
    }, 100);
}

// Update image count display
function updateImageCount() {
    const countElement = document.getElementById('imageCount');
    const errorElement = document.getElementById('imageError');
    
    const remainingExisting = getRemainingExistingImagesCount();
    const totalImages = remainingExisting + selectedImages.length;
    
    // Clear previous error if count is valid
    if (totalImages >= 3) {
        errorElement.textContent = '';
    }
    
    if (totalImages === 0) {
        countElement.textContent = 'No images selected. 3 images required.';
        countElement.className = 'text-danger small mt-2';
    } else if (totalImages < 3) {
        countElement.textContent = `${totalImages}/3 images selected. ${3 - totalImages} more needed.`;
        countElement.className = 'text-warning small mt-2';
    } else if (totalImages === 3) {
        countElement.textContent = `${totalImages}/3 images selected âœ“`;
        countElement.className = 'text-success small mt-2';
    } else {
        countElement.textContent = `${totalImages}/3 images - Too many! Remove ${totalImages - 3}.`;
        countElement.className = 'text-danger small mt-2';
    }
}

// Form Validation
function validateForm() {
    let isValid = true;
    clearErrors();

    // Validate Product Name
    const productName = document.querySelector('[name="productName"]').value.trim();
    if (!productName) {
        showError('error-productName', 'Product name is required');
        isValid = false;
    } else if (productName.length < 3) {
        showError('error-productName', 'Product name must be at least 3 characters');
        isValid = false;
    }

    // Validate Description
    const description = document.querySelector('[name="description"]').value.trim();
    if (!description) {
        showError('error-description', 'Description is required');
        isValid = false;
    } else if (description.length < 10) {
        showError('error-description', 'Description must be at least 10 characters');
        isValid = false;
    }

    // Validate Category
    const category = document.querySelector('[name="category"]').value;
    if (!category) {
        showError('error-category', 'Category is required');
        isValid = false;
    }

    // Validate Variants
    const variantNames = document.querySelectorAll('[name="variantName[]"]');
    const variantPrices = document.querySelectorAll('[name="variantPrice[]"]');
    const variantStocks = document.querySelectorAll('[name="variantStock[]"]');

    if (variantNames.length === 0) {
        showError('variant-main-error', 'At least one variant is required');
        isValid = false;
    }

    variantNames.forEach((input, index) => {
        const name = input.value.trim();
        const price = variantPrices[index].value;
        const quantity = variantStocks[index].value;

        if (!name) {
            input.nextElementSibling.textContent = 'Variant name required';
            isValid = false;
        }
        if (!price || price <= 0) {
            variantPrices[index].nextElementSibling.textContent = 'Valid price required';
            isValid = false;
        }
        if (!quantity || quantity < 0) {
            variantStocks[index].nextElementSibling.textContent = 'Valid stock required';
            isValid = false;
        }
    });

    // Validate Images - MUST BE EXACTLY 3
    const remainingExisting = getRemainingExistingImagesCount();
    const totalImages = remainingExisting + selectedImages.length;
    
    if (totalImages !== 3) {
        if (totalImages < 3) {
            showError('imageError', `Exactly 3 images required. You have ${totalImages}. Add ${3 - totalImages} more.`);
        } else {
            showError('imageError', `Exactly 3 images required. You have ${totalImages}. Remove ${totalImages - 3}.`);
        }
        isValid = false;
    }

    // Validate new image files (if any)
    if (selectedImages.length > 0) {
        for (let i = 0; i < selectedImages.length; i++) {
            const file = selectedImages[i];
            if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/jpg')) {
                showError('imageError', 'Only PNG, JPG, JPEG files are allowed');
                isValid = false;
                break;
            }
            if (file.size > 2 * 1024 * 1024) {
                showError('imageError', 'Each image must be less than 2MB');
                isValid = false;
                break;
            }
        }
    }

    if (isValid) {
        submitForm();
    } else {
        // Scroll to first error
        const firstError = document.querySelector('.text-danger:not(:empty)');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Submit Form with AJAX
async function submitForm() {
    const form = document.getElementById('editProduct');
    const productId = form.action.split('/').pop();
    const formData = new FormData();

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

    try {
        // Basic fields
        formData.append('productName', document.querySelector('[name="productName"]').value.trim());
        formData.append('description', document.querySelector('[name="description"]').value.trim());
        formData.append('category', document.querySelector('[name="category"]').value);
        formData.append('status', document.querySelector('[name="status"]').value);
        formData.append('featured', document.querySelector('[name="featured"]').checked);

        // Variants
        const variantNames = document.querySelectorAll('[name="variantName[]"]');
        const variantPrices = document.querySelectorAll('[name="variantPrice[]"]');
        const variantStocks = document.querySelectorAll('[name="variantStock[]"]');

        const variants = [];
        variantNames.forEach((input, index) => {
            variants.push({
                size: input.value.trim(),
                price: parseFloat(variantPrices[index].value),
                quantity: parseInt(variantStocks[index].value)
            });
        });
        formData.append('variants', JSON.stringify(variants));

        // Images to remove
        const removeImages = document.querySelectorAll('[name="removeImages[]"]:checked');
        removeImages.forEach(checkbox => {
            formData.append('removeImages[]', checkbox.value);
        });

        // New images
        selectedImages.forEach(img => {
            formData.append('images', img);
        });

        // Send PUT request using fetch
        const response = await fetch(`/admin/products/edit/${productId}`, {
            method: 'PUT',
            body: formData
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            alert(data.message || 'Failed to update product');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            return;
        }
        showToast('success', 'Product updated successfully!');

        setTimeout(() => {
        window.location.href = '/admin/products';
        }, 1000);

        

    } catch (error) {
        console.error('Error:', error);
        showToast('error','An error occurred while updating the product');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
}

function showError(id, message) {
    const errorElement = document.getElementById(id);
    if (errorElement) {
        errorElement.textContent = message;
    }
}

function clearError(id) {
    const errorElement = document.getElementById(id);
    if (errorElement) {
        errorElement.textContent = '';
    }
}

function clearErrors() {
    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
    document.querySelectorAll('.variant-error').forEach(el => el.textContent = '');
}
</script>


