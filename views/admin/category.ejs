<style>
.category-thead th {
  background-color: #f5f1ea;         /* exact beige header */
  font-size: 16px;                   /* small text like screenshot */
  font-weight: 600;                  /* semi-bold */
  text-transform: none;
  color: #6b6b6b;                    /* muted gray text */
  border-bottom: 1px solid #e9dfd1;  /* light border */
}

.category-card {
  border-radius: 18px;
  overflow: hidden;                  
}

.category-table tbody td {
  background: #ffffff;
}

.offer-toggle {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.offer-toggle input { display: none; }

.offer-slider {
  width: 46px;
  height: 24px;
  border-radius: 999px;
  background-color: #d9dde4;
  position: relative;
  transition: background-color 0.2s ease;
}

.offer-slider::before {
  content: "";
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #ffffff;
  transition: transform 0.2s ease;
}

.offer-toggle input:checked + .offer-slider {
  background-color: #b8c9ae;
}

.offer-toggle input:checked + .offer-slider::before {
  transform: translateX(20px);
}

</style>

<%- include('../../views/partials/admin/header.ejs') %>

<!-- PAGE CONTENT -->
<main class="page-content">

  
  <div class="category-page-wrapper py-2 px-2">

   
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="fw-semibold mb-1">Categories</h4>
        <p class="text-muted mb-0" style="font-size: 1.2rem;">
          Manage product categories
        </p>
      </div>

      <button type="button"
        class="btn d-inline-flex align-items-center btn-add-category"
        style="background-color:#b8c9ae; border:none;"
        data-bs-toggle="modal"
        data-bs-target="#addCategoryModal">
        <span class="me-2 fw-bold">+</span>
        <span>Add Category</span>
        </button>
    </div>

        <!-- Add New Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px; overflow:hidden;">

      <!-- Header -->
      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <form action="/admin/categories/add" method="POST" enctype="multipart/form-data" onsubmit="return handleFormSubmit(event)">
        <div class="modal-body px-4">

          <!-- Category Name -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Name <span class="text-danger">*</span></label>
            <input type="text"
                   name="name"
                   class="form-control"
                   id ="name"
                   >
            <div id="nameError" class="text-danger small mt-1"></div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label mb-1">Description</label>
            <textarea name="description"
                      class="form-control"
                      rows="3"
                      id="description"
                      placeholder="Brief description of this category"></textarea>
            <div id="descriptionError" class="text-danger small mt-1"></div>
          </div>

          <!-- Category Image -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Image</label>
            <input type="file"
                   name="image"
                   class="form-control"
                   accept="image/*">
            <small class="text-muted">Recommended: square image, good resolution (e.g., 800Ã—800).</small>
            <div id="imageError" class="text-danger small mt-1"></div>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer border-0 px-4 py-3" style="background:#f5eee4;">
          <button type="button"
                  class="btn btn-link text-muted"
                  data-bs-dismiss="modal">
            Cancel
          </button>

          <button type="submit"
                  class="btn px-4"
                  style="background:#b8c9ae; color:#fff; border-radius:999px;">
            Save Category
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

    <!-- White card with table -->
    <div class="card border-0 shadow-sm category-card">
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
            <thead class="category-thead ">
            <tr >
                <th class="py-3 ps-4 fw-bold text-muted" >Name</th>
                <th class="py-3 fw-bold text-muted">Description</th>
                <th class="py-3 fw-bold text-muted">Status</th>
                <th class="py-3 fw-bold text-muted">Offer</th>
                <th class="py-3 pe-4 fw-bold text-muted text-end">Actions</th>
            </tr>
            </thead>
            <tbody style="font-size:20px;">

            <% if (!cat || cat.length === 0) { %>
            <tr>
            <td colspan="5" class="text-center text-muted py-4">
                 No categories found
            </td>
            </tr>
            <% } else { %>
                <% for(let i=0 ; i< cat.length; i++){ %>
        <tr>
        
            <td class="ps-4"><%= cat[i].name %></td>  <!-- Category Name -->
            <td><%= cat[i].description || '-' %></td>  <!-- Category Descripiton -->
            
            <!-- Category Status -->
            <td>
             <% if (cat[i].is_active) { %>
                <a href="/admin/categories/inactivate?id=<%= cat[i]._id %>" 
                class="status-pill status-active"
                style="cursor:pointer; text-decoration: none;">
                Active</a>
            <% } else { %>
                <a href="/admin/categories/activate?id=<%= cat[i]._id %>"
                class="status-pill status-blocked"
                style="cursor:pointer;text-decoration: none;">
                Inactive</a>
            <% } %>
            </td>

         <!-- Category Offer -->

    <td>
      <label class="offer-toggle" 
       data-id="<%= cat[i]._id %>" 
       data-offer="<%= cat[i].offerPercent %>"
       data-name="<%= cat[i].name %>">

        <input type="checkbox" <%= cat[i].hasOffer ? "checked" : "" %>>
        <span class="offer-slider"></span>
        <span class="offer-label">
        <%= cat[i].hasOffer ? cat[i].offerPercent + "% off" : "" %>
        </span>
        </label>
        </td>

            <!-- Edit Category  -->
            <!-- Edit Category Button -->
<td class="text-end pe-4">
  <button class="btn btn-link p-0 me-2 text-secondary"
    data-bs-toggle="modal"
    data-bs-target="#editCategoryModal-<%= cat[i]._id %>">
    <i class="bi bi-pencil-square fs-4"></i>
  </button>
</td>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal-<%= cat[i]._id %>" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px; overflow:hidden;">

      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="edit-form-<%= cat[i]._id %>"
            action="/admin/categories/update/<id>"
            enctype="multipart/form-data"
            onsubmit="return handleEditFormSubmit(event)">

        <div class="modal-body px-4">
          <input type="hidden" name="id" value="<%= cat[i]._id %>">

          <!-- Name -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Name <span class="text-danger">*</span></label>

            <input type="text"
              name="name"
              id="edit-name-<%= cat[i]._id %>"
              class="form-control"
              value="<%= cat[i].name %>">

            <div id="edit-nameError-<%= cat[i]._id %>" class="text-danger small mt-1"></div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label mb-1">Description</label>

            <textarea name="description"
              id="edit-description-<%= cat[i]._id %>"
              class="form-control"
              rows="3"><%= cat[i].description %></textarea>

            <div id="edit-descriptionError-<%= cat[i]._id %>" class="text-danger small mt-1"></div>
          </div>

          <!-- Image -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Image</label>

            <input type="file"
              name="image"
              id="edit-image-<%= cat[i]._id %>"
              class="form-control"
              accept="image/*">

            <small class="text-muted d-block mb-1">
              Leave empty to keep existing image.
            </small>

            <% if (cat[i].image) { %>
              <img src="<%= cat[i].image %>" alt="<%= cat[i].name %>"
                   style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
            <% } %>

            <div id="edit-imageError-<%= cat[i]._id %>" class="text-danger small mt-1"></div>
          </div>

        </div>

        <div class="modal-footer border-0 px-4 py-3" style="background:#f5eee4;">
          <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">
            Cancel
          </button>

          <button type="submit" class="btn px-4" style="background:#b8c9ae; color:#fff; border-radius:999px;">
            Save Changes
          </button>
        </div>

      </form>

    </div>
  </div>
</div>


      </tr>

    <% } %>





                <!-- Category offer modal -->
<div class="modal fade" id="categoryOfferModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px;">

      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Add Category Offer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body px-4">
        <p id="offerCategoryTitle"></p>

        <label class="form-label">Discount Percentage (%)</label>
        <div class="input-group">
          <input type="number" id="categoryOfferValue" class="form-control" min="0" max="90" value="0">
          <span class="input-group-text">%</span>
        </div>
      </div>

      <div class="modal-footer" style="background:#f5eee4;">
        <button class="btn btn-link text-muted" data-bs-dismiss="modal">Cancel</button>
        <button class="btn" id="saveCategoryOfferBtn" style="background:#b8c9ae;color:white;border-radius:25px;">
          Save Offer
        </button>
      </div>
    </div>
  </div>
</div>
  <% } %>

</tbody>

        </table>
        </div>
    </div>
</div>



</main>        
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  async function handleFormSubmit(event) {
    event.preventDefault();

    if (!validateForm()) {
      return false; 
    }

    const form = event.target;
    const formData = new FormData(form);

    clearErrorMessages(); 

    try {
      const response = await fetch(form.action, {
        method: form.method,
        body: formData
      });

      const data = await response.json();

      if (!response.ok) {
      
        if (data.error) {
          document.getElementById("nameError").textContent = data.error;
        } else {
          document.getElementById("nameError").textContent =
            "Something went wrong. Please try again.";
        }
        return false;
      }

     
      // close modal and reload page to show new category in table
      const modalEl = document.getElementById('addCategoryModal');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();

      // Optional: clear form
      form.reset();

      // reload to show new category
      window.location.reload();

      return true;

    } catch (err) {
      console.error(err);
      document.getElementById("nameError").textContent =
        "Something went wrong. Please try again.";
      return false;
    }
  }

  function validateForm() {
    clearErrorMessages();

    const nameInput = document.getElementsByName("name")[0];
    const descriptionInput = document.getElementsByName("description")[0];
    const imageInput = document.getElementsByName("image")[0];

    const name = nameInput.value.trim();
    const description = descriptionInput.value.trim();

    let isValid = true;

    // NAME VALIDATION
    if (!name) {
      document.getElementById("nameError").textContent = "Category name is required.";
      isValid = false;
    } else if (name.length < 3) {
      document.getElementById("nameError").textContent = "Category name should be at least 3 characters.";
      isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(name)) {
      document.getElementById("nameError").textContent = "Category name should contain only alphabetic characters.";
      isValid = false;
    }

    // DESCRIPTION VALIDATION
    if (!description) {
      document.getElementById("descriptionError").textContent = "Please write a description.";
      isValid = false;
    } else if (description.length < 5) {
      document.getElementById("descriptionError").textContent =
        "Description should be at least 5 characters.";
      isValid = false;
    }

    // IMAGE VALIDATION (optional)
    if (imageInput && imageInput.files.length > 0) {
      const file = imageInput.files[0];
      const maxSize = 2 * 1024 * 1024; // 2MB

      if (!file.type.startsWith("image/")) {
        document.getElementById("imageError").textContent = "Please upload a valid image file.";
        isValid = false;
      } else if (file.size > maxSize) {
        document.getElementById("imageError").textContent = "Image size should be less than 2MB.";
        isValid = false;
      }
    }

    return isValid;
  }

  function clearErrorMessages() {
    document.getElementById("nameError").textContent = "";
    document.getElementById("descriptionError").textContent = "";
    document.getElementById("imageError").textContent = "";
  }
</script>


<script>
async function handleEditFormSubmit(event) {
  event.preventDefault();

  const form = event.target;                      
  const formId = form.id;                          // edit-form-<id>
  const categoryId = form.querySelector('input[name="id"]').value;


  const nameInput = document.getElementById(`edit-name-${categoryId}`);
  const descInput = document.getElementById(`edit-description-${categoryId}`);
  const imageInput = document.getElementById(`edit-image-${categoryId}`);

  const nameError = document.getElementById(`edit-nameError-${categoryId}`);
  const descError = document.getElementById(`edit-descriptionError-${categoryId}`);
  const imageError = document.getElementById(`edit-imageError-${categoryId}`);

  // Clear previous errors
  nameError.textContent = "";
  descError.textContent = "";
  imageError.textContent = "";

  // Basic validation
  if (!nameInput.value.trim()) {
    nameError.textContent = "Category name is required.";
    return false;
  }

  // Prepare FormData for file upload
  const formData = new FormData(form);

  try {
    const response = await fetch(`/admin/categories/update/${categoryId}`, {
      method: "PUT",
      body: formData,
    });

    const result = await response.json();

    if (!response.ok) {
      // Show backend errors
      if (result.error.includes("name")) {
        nameError.textContent = result.error;
      } else {
        Swal.fire("Error", result.error, "error");
      }
      return false;
    }

    // SUCCESS
    Swal.fire({
      icon: "success",
      title: "Updated!",
      text: "Category updated successfully",
      timer: 1500,
      showConfirmButton: false
    });

    // Close modal
    const modal = bootstrap.Modal.getInstance(
      document.getElementById(`editCategoryModal-${categoryId}`)
    );
    modal.hide();

    // Reload table to show updated details
    setTimeout(() => location.reload(), 500);

  } catch (err) {
    console.error("Edit request failed:", err);
    Swal.fire("Error", "Something went wrong!", "error");
  }

  return false;
}
</script>


<script>
let selectedCategoryId = null;

// EVENT: User toggles offer checkbox
document.querySelectorAll(".offer-toggle input").forEach(checkbox => {
  checkbox.addEventListener("change", function () {
    const wrapper = this.closest(".offer-toggle");
    const id = wrapper.dataset.id;
    const name = wrapper.dataset.name;
    const currentOffer = wrapper.dataset.offer || 0;

    if (this.checked) {
      // TOGGLE ON - OPEN MODAL
      selectedCategoryId = id;

      document.getElementById("offerCategoryTitle").textContent =
        `Add offer for: ${name}`;
      
      document.getElementById("categoryOfferValue").value = currentOffer;

      new bootstrap.Modal(document.getElementById("categoryOfferModal")).show();
    } else {
      //TOGGLE OFF -Remove offer immediately
      removeOffer(id, wrapper, this);
    }
  });
});


//Toggle OFF logic
async function removeOffer(categoryId, wrapper, checkbox) {
  try {
    const res = await fetch(`/admin/categories/offer?id=${categoryId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ percent: 0 })  // reset everything
    });

    const data = await res.json();

    if (!data.success) {
      alert(data.message);
      checkbox.checked = true; // revert on failure
      return;
    }

    wrapper.querySelector(".offer-label").textContent = "";
    wrapper.dataset.offer = 0;

  } catch (err) {
    console.error(err);
    alert("Error removing offer");
    checkbox.checked = true;
  }
}


// SAVE OFFER BUTTON
document.getElementById("saveCategoryOfferBtn").addEventListener("click", async () => {
  const percent = Number(document.getElementById("categoryOfferValue").value) || 0;

  try {
    const res = await fetch(`/admin/categories/offer?id=${selectedCategoryId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ percent })
    });

    const data = await res.json();

    if (!data.success) {
      alert(data.message);
      return;
    }

    // Update label text
    const wrapper = document.querySelector(`.offer-toggle[data-id="${selectedCategoryId}"]`);
    wrapper.dataset.offer = percent;
    wrapper.querySelector(".offer-label").textContent = percent > 0 ? `${percent}% off` : "";

    bootstrap.Modal.getInstance(document.getElementById("categoryOfferModal")).hide();

    window.location.reload();

  } catch (err) {
    console.error(err);
    alert("Error saving offer");
  }
});
</script>



