<%- include('../../views/partials/admin/header.ejs') %>
<link rel="stylesheet" href="/css/admin/category.css">
<!-- PAGE CONTENT -->
<main class="page-content">

  
  <div class="category-page-wrapper py-1 px-1">

   
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="fw-semibold mb-1">Categories</h4>
        <p class="text-muted mb-0" style="font-size: 1.2rem;">
          Manage product categories
        </p>
      </div>
</div>
    <form method="GET" action="/admin/categories" class="flex-grow-1">
      <div class="bg-white p-3 rounded-3 shadow-sm mb-3 d-flex flex-wrap align-items-center gap-3">

  <!-- Search bar -->
  <div class="flex-grow-1">
    <input 
      type="text" 
      id="categorySearch" 
       name="search"
    class="form-control rounded-pill category-search-input"
    placeholder="Search categories..."
    value="<%= search || '' %>"
    >
  </div></form>

  <!-- Add Category Button -->
  <button type="button"
    class="btn d-inline-flex align-items-center btn-add-category"
    style="background-color:#b8c9ae; border:none;"
    data-bs-toggle="modal"
    data-bs-target="#addCategoryModal">
      <span class="me-2 fw-bold">+</span>
      <span>Add Category</span>
  </button>

</div>
    

        <!-- Add New Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px; overflow:hidden;">


      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

   
      <form action="/admin/categories/add" method="POST" enctype="multipart/form-data" onsubmit="return handleFormSubmit(event)">
        <div class="modal-body px-4">

          <!-- Category Name -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Name <span class="text-danger">*</span></label>
            <input type="text"
                   name="name"
                   class="form-control"
                   id ="name"
                   >
            <div id="nameError" class="text-danger small mt-1"></div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label mb-1">Description</label>
            <textarea name="description"
                      class="form-control"
                      rows="3"
                      id="description"
                      placeholder="Brief description of this category"></textarea>
            <div id="descriptionError" class="text-danger small mt-1"></div>
          </div>

          <!-- Category Image -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Image</label>
            <input type="file"
                   name="image"
                   class="form-control"
                   accept="image/*">
            <small class="text-muted">Recommended: square image, good resolution (e.g., 800×800).</small>
            <div id="imageError" class="text-danger small mt-1"></div>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer border-0 px-4 py-3" style="background:#f5eee4;">
          <button type="button"
                  class="btn btn-link text-muted"
                  data-bs-dismiss="modal">
            Cancel
          </button>

          <button type="submit"
                  class="btn px-4"
                  style="background:#b8c9ae; color:#fff; border-radius:999px;">
            Save Category
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

    <!-- White card with table -->
    <div class="card border-0 shadow-sm category-card">
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
            <thead class="category-thead ">
            <tr >
                
                <th class="py-3 ps-4 fw-bold text-muted" >Name</th>
                <th class="py-3 fw-bold text-muted">Description</th>
                <th class="py-3 fw-bold text-muted">Status</th>
                <th class="py-3 fw-bold text-muted">Offer</th>
                <th class="py-3 pe-4 fw-bold text-muted text-end">Actions</th>
            </tr>
            </thead>
            <tbody style="font-size:20px;">

            <% if (!cat || cat.length === 0) { %>
            <tr >
            <td colspan="5" class="text-center text-muted py-4">
                 No categories found
            </td>
            </tr>
            <% } else { %>
                <% for(let i=0 ; i< cat.length; i++){ %>
        <tr id="category-row-<%= cat[i]._id %>">
            <td class="d-flex align-items-center gap-3">
          <img src="<%= cat[i].image %>" class="rounded" width="45">
          <%= cat[i].name %>
        </td>
            
            <td><%= cat[i].description || '-' %></td>  
            
   <!-- Category Status -->
<td>
  <% if (cat[i].is_active) { %>
    <button type="button"
            class="status-pill status-active toggle-status"
            data-id="<%= cat[i]._id %>"
            data-action="inactivate"
            data-name="<%= cat[i].name %>">
      Active
    </button>
  <% } else { %>
    <button type="button"
            class="status-pill status-blocked toggle-status"
            data-id="<%= cat[i]._id %>"
            data-action="activate"
            data-name="<%= cat[i].name %>">
      Inactive
    </button>
  <% } %>
</td>

         <!-- Category Offer -->

    <td>
      <label class="offer-toggle" 
       data-id="<%= cat[i]._id %>" 
       data-offer="<%= cat[i].offerPercent %>"
       data-name="<%= cat[i].name %>">

        <input type="checkbox" <%= cat[i].hasOffer ? "checked" : "" %>>
        <span class="offer-slider"></span>
        <span class="offer-label">
        <%= cat[i].hasOffer ? cat[i].offerPercent + "% off" : "" %>
        </span>
        </label>
        </td>

        
           
<!-- Edit Category  -->
<td class="text-end pe-2">
  <button class="btn btn-link p-0 me-2 text-secondary btn-edit-category"
          data-id="<%= cat[i]._id %>"
          data-name="<%= cat[i].name %>"
          data-description="<%= cat[i].description || '' %>"
          data-image="<%= cat[i].image || '' %>">
    <i class="bi bi-pencil-square fs-4"></i>
  </button>



<button class="btn btn-link p-0 me-2 text-danger btn-delete-category"
        data-id="<%= cat[i]._id %>"
        data-name="<%= cat[i].name %>">
  <i class="bi bi-trash fs-4"></i>
</button>
</td>


    <% } %>

  <% } %>
  
  <!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px; overflow:hidden;">

      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="editCategoryForm" enctype="multipart/form-data" onsubmit="return handleEditFormSubmit(event)">
        <input type="hidden" id="editCategoryId" name="id">
        
        <div class="modal-body px-4">

          <!-- Category Name -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Name <span class="text-danger">*</span></label>
            <input type="text"
                   name="name"
                   class="form-control"
                   id="editName">
            <div id="editNameError" class="text-danger small mt-1"></div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label mb-1">Description</label>
            <textarea name="description"
                      class="form-control"
                      rows="3"
                      id="editDescription"
                      placeholder="Brief description of this category"></textarea>
            <div id="editDescriptionError" class="text-danger small mt-1"></div>
          </div>

          <!-- Current Image Preview -->
          <div class="mb-3" id="currentImagePreview" style="display:none;">
            <label class="form-label mb-1">Current Image</label>
            <div>
              <img id="editCurrentImage" src="" alt="Current category image" style="max-width: 150px; max-height: 150px; border-radius: 8px;">
            </div>
          </div>

          <!-- Category Image -->
          <div class="mb-3">
            <label class="form-label mb-1">Category Image (optional)</label>
            <input type="file"
                   name="image"
                   class="form-control"
                   id="editImage"
                   accept="image/*">
            <small class="text-muted">Leave empty to keep current image. Recommended: square image, good resolution (e.g., 800×800).</small>
            <div id="editImageError" class="text-danger small mt-1"></div>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer border-0 px-4 py-3" style="background:#f5eee4;">
          <button type="button"
                  class="btn btn-link text-muted"
                  data-bs-dismiss="modal">
            Cancel
          </button>

          <button type="submit"
                  class="btn px-4"
                  style="background:#b8c9ae; color:#fff; border-radius:999px;">
            Update Category
          </button>
        </div>
      </form>

    </div>
  </div>
</div>


<!-- Status Confirmation Modal -->
<div class="modal fade" id="statusConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px">

      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="statusConfirmText" class="mb-0 text-muted"></p>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>

        <form id="statusConfirmForm">
          <button type="submit"
                  class="btn"
                  style="background:#e5c8b8; color:#2b2b2b;">
            Yes, Confirm
          </button>
        </form>
      </div>

    </div>
  </div>
</div>





                <!-- Category offer modal -->
<div class="modal fade" id="categoryOfferModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px;">

      <div class="modal-header border-0 px-4 pt-4 pb-2">
        <h5 class="modal-title fw-semibold">Add Category Offer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body px-4">
        <p id="offerCategoryTitle"></p>

        <label class="form-label">Discount Percentage (%)</label>
        <div class="input-group">
          <input type="number" id="categoryOfferValue" class="form-control" min="0" max="90" value="0">
          <span class="input-group-text">%</span>
        </div>
      </div>

      <div class="modal-footer" style="background:#f5eee4;">
        <button class="btn btn-link text-muted" data-bs-dismiss="modal">Cancel</button>
        <button class="btn" id="saveCategoryOfferBtn" style="background:#b8c9ae;color:white;border-radius:25px;">
          Save Offer
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px">

      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold text-danger">Delete Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="deleteConfirmText" class="mb-0 text-muted"></p>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>

        <button type="button"
                id="confirmDeleteBtn"
                class="btn btn-danger">
          Yes, Delete
        </button>
      </div>

    </div>
  </div>
</div>

</tbody>

        </table>
        </div>
    </div>
</div>

<%- include('../../views/partials/admin/footer.ejs') %>

</main>        
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let selectedCategoryId = null;
</script>

<script src="/js/admin/category/add.category.js"></script>
<script src="/js/admin/category/edit.category.js"></script>
<script src="/js/admin/category/offer.category.js"></script>
<script src="/js/admin/category/status.category.js"></script>
<script src="/js/admin/category/delete.category.js"></script>











