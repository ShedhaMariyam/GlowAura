<style>
    .form-label {
  font-size: 16px;
}

.border-dashed {
  border-style: dashed !important;
}

.form-control,
.form-select {
  border-radius: 10px;
  padding: 10px 14px;
}

.bg-white {
  border-radius: 12px !important;
}

.variant-error {
    color: red;
    font-size: 12px;
    margin-top: -6px;
    margin-bottom: 8px;
}
.image-thumbnail-wrapper {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
}

.image-thumbnail-wrapper img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  transition: transform 0.2s;
  cursor: pointer;
}

.image-thumbnail-wrapper:hover img {
  transform: scale(1.05);
}

.thumbnail-actions {
  position: absolute;
  top: 5px;
  right: 5px;
  display: flex;
  gap: 5px;
}

.thumbnail-actions button {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  opacity: 0.9;
}

.thumbnail-actions button:hover {
  opacity: 1;
}

.image-number {
  position: absolute;
  bottom: 5px;
  left: 5px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}
</style>
<%- include('../../views/partials/admin/header.ejs') %>

<form action="/admin/products/add" method="POST" enctype="multipart/form-data"  id="addProduct">

  <!-- PAGE HEADER -->
  <div class="d-flex align-items-center mb-4 py-2 px-4">
   
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="fw-semibold mb-1">Add New Product</h4>
        <p class="text-muted mb-0" style="font-size: 1.2rem;">
          Create a new product
        </p>
      </div>
      </div>
    <button type="submit" class="btn  ms-auto px-4" style="background-color:#b8c9ae; border:none;" onclick="validateForm()">
      <i class="bi bi-check2-circle me-1"></i> Save Product
    </button>
  </div>


  <div class="row py-2 px-4">

    <!-- LEFT SECTION -->
    <div class="col-lg-8 ">

      <!-- BASIC INFORMATION -->
      <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
        <h5 class="fw-semibold mb-3">Basic Information</h5>

        <!-- Product Name -->
        <div class="mb-3">
          <label class="form-label fw-medium">Product Name <span class="text-danger">*</span></label>
          <input type="text" name="productName" class="form-control" placeholder="Enter product name">
          <div id="error-productName" class="text-danger small"></div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label fw-medium">Description <span class="text-danger">*</span></label>
          <textarea name="description" class="form-control" rows="4" placeholder="Enter product description"></textarea>
            <div id="error-description" class="text-danger small"></div>
        </div>

        <!-- Category + SKU -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-medium">Category <span class="text-danger">*</span></label>
            <select name="category" class="form-select" >
               
                <% for(let i=0;i<cat.length;i++){%>
              <option value="<%=cat[i].name%>"><%=cat[i].name%></option>
              <%}%>
            </select>
             <div id="error-category" class="text-danger small"></div>
          </div>
        </div>

      </div>

      <!-- PRICING & INVENTORY -->
<div class="bg-white p-4 rounded-3 shadow-sm mb-4">
  <h5 class="fw-semibold mb-3">Pricing and Inventory</h5>
  
  <div id="variantContainer">
    <!-- First variant row -->
    <div class="variant-row mb-3">
      <div class="d-flex gap-3 align-items-start">
        <div class="flex-fill">
          <input type="text" name="variantName[]" class="form-control" placeholder="Size (e.g., 50ml)">
          <div class="variant-error text-danger small"></div>
        </div>
        <div class="flex-fill">
          <input type="number" name="variantPrice[]" step="0.01" class="form-control" placeholder="Price ($)">
          <div class="variant-error text-danger small"></div>
        </div>
        <div class="flex-fill">
          <input type="number" name="variantStock[]" class="form-control" placeholder="Stock">
          <div class="variant-error text-danger small"></div>
        </div>
        <button type="button" class="btn btn-light border removeVariant" style="min-width: 40px;">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="variant-main-error" class="text-danger small mb-2"></div>

  <button type="button" id="addVariantBtn" class="btn btn-outline-secondary rounded-pill mt-2">
    <i class="bi bi-plus-lg me-1"></i> Add Variant
  </button>
</div>
    </div>


    <!-- RIGHT SECTION -->
    <div class="col-lg-4">

      <!-- VISIBILITY -->
      <div class="bg-white p-4 rounded-3 shadow-sm mb-4">
        <h5 class="fw-semibold mb-3">Product Visibility</h5>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-medium">Featured Product</span>
          <div class="form-check form-switch">
            <input class="form-check-input" name="featured" type="checkbox">
          </div>
        </div>

        <label class="fw-medium">Product Status</label>
        <select name="status" class="form-select">
          <option value="Listed">Listed</option>
          <option value="Unlisted">Unlisted</option>
        </select>
      </div>

  
   <!-- PRODUCT IMAGES -->
<!-- PRODUCT IMAGES -->
<div class="bg-white p-4 rounded-3 shadow-sm mb-4">
  <h5 class="fw-semibold mb-3">Product Images</h5>

  <div class="border border-2 border-dashed rounded-3 p-4 text-center" style="border-style:dashed;" id="uploadArea">
    <i class="bi bi-upload fs-2 text-muted"></i>
    <p class="mb-0 mt-2 text-muted">Click to upload <br> or drag and drop</p>
    <small class="text-muted">PNG, JPG, JPEG (MAX. 2MB per image)</small>

    <input type="file"
           name="images[]"
           id="productImages"
           class="form-control mt-3"
           multiple
           accept="image/png, image/jpeg, image/jpg">
  </div>
  
  <!-- Image Thumbnails Container -->
  <div id="imageThumbnails" class="row g-3 mt-3"></div>
  
  <div id="imageError" class="text-danger small mt-2"></div>
  <div id="imageCount" class="text-muted small mt-2"></div>
</div>

    </div>

  </div>

</form>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>

let selectedImages = []; 
let cropper = null;

document.addEventListener('DOMContentLoaded', function() {
    
    // Add Variant Button Handler
    document.getElementById('addVariantBtn').addEventListener('click', function() {
        const container = document.getElementById('variantContainer');
        const newVariant = document.createElement('div');
        newVariant.className = 'variant-row mb-3';
        newVariant.innerHTML = `
            <div class="d-flex gap-3 align-items-start">
                <div class="flex-fill">
                    <input type="text" name="variantName[]" class="form-control" placeholder="Size (e.g., 50ml)">
                    <div class="variant-error text-danger small"></div>
                </div>
                <div class="flex-fill">
                    <input type="number" name="variantPrice[]" step="0.01" class="form-control" placeholder="Price ($)">
                    <div class="variant-error text-danger small"></div>
                </div>
                <div class="flex-fill">
                    <input type="number" name="variantStock[]" class="form-control" placeholder="Stock">
                    <div class="variant-error text-danger small"></div>
                </div>
                <button type="button" class="btn btn-light border removeVariant" style="min-width: 40px;">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        `;
        container.appendChild(newVariant);
    });

    // Remove Variant Handler (Event Delegation)
    document.getElementById('variantContainer').addEventListener('click', function(e) {
        if (e.target.closest('.removeVariant')) {
            const variants = document.querySelectorAll('.variant-row');
            if (variants.length > 1) {
                e.target.closest('.variant-row').remove();
            } else {
                showError('variant-main-error', 'At least one variant is required');
                setTimeout(() => clearError('variant-main-error'), 3000);
            }
        }
    });

    // Image Upload Handler - Support multiple selections
    document.getElementById('productImages').addEventListener('change', function(e) {
        handleImageSelection(e.target.files);
        // Reset input to allow selecting same files again
        e.target.value = '';
    });

    // Form Submit Handler
    document.getElementById('addProduct').addEventListener('submit', function(e) {
        e.preventDefault();
        validateForm();
    });
});

// Handle Image Selection and Show Thumbnails
function handleImageSelection(files) {
    if (files.length === 0) return;

    // Add new files to existing selection
    Array.from(files).forEach(file => {
        selectedImages.push(file);
    });

    displayImageThumbnails();
    updateImageCount();
}

// Display Image Thumbnails
function displayImageThumbnails() {
    const thumbnailContainer = document.getElementById('imageThumbnails');
    thumbnailContainer.innerHTML = ''; // Clear existing thumbnails

    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3';
            col.setAttribute('data-index', index);
            col.innerHTML = `
                <div class="image-thumbnail-wrapper">
                    <img src="${e.target.result}" alt="Product Image ${index + 1}">
                    <div class="thumbnail-actions">
                        <button type="button" class="btn btn-sm btn-primary crop-image-btn" data-index="${index}" title="Crop">
                            <i class="bi bi-crop"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger remove-image-btn" data-index="${index}" title="Remove">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="image-number">#${index + 1}</div>
                </div>
            `;
            thumbnailContainer.appendChild(col);
        };
        reader.readAsDataURL(file);
    });

    // Attach event listeners after thumbnails are added
    setTimeout(() => {
        attachThumbnailEvents();
    }, 100);
}

// Attach Event Listeners to Thumbnail Buttons
function attachThumbnailEvents() {
    // Crop buttons
    document.querySelectorAll('.crop-image-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const index = parseInt(this.getAttribute('data-index'));
            openCropModal(index);
        });
    });

    // Remove buttons
    document.querySelectorAll('.remove-image-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const index = parseInt(this.getAttribute('data-index'));
            removeImage(index);
        });
    });
}

// Remove Image
function removeImage(index) {
    selectedImages.splice(index, 1);
    displayImageThumbnails();
    updateImageCount();
}

// Update Image Count Display
function updateImageCount() {
    const countElement = document.getElementById('imageCount');
    const count = selectedImages.length;
    
    if (count === 0) {
        countElement.textContent = '';
    } else if (count < 3) {
        countElement.textContent = `${count} image(s) selected. At least 3 images required.`;
        countElement.className = 'text-warning small mt-2';
    } else {
        countElement.textContent = `${count} image(s) selected âœ“`;
        countElement.className = 'text-success small mt-2';
    }
}

// Open Crop Modal
function openCropModal(index) {
    const file = selectedImages[index];
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cropModal');
    if (existingModal) existingModal.remove();

    // Create modal
    const modal = document.createElement('div');
    modal.id = 'cropModal';
    modal.className = 'modal fade';
    modal.setAttribute('data-bs-backdrop', 'static');
    modal.innerHTML = `
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image #${index + 1}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="min-height: 500px;">
                    <div class="crop-container" style="width: 100%; height: 600px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                        <img id="cropperImage" style="max-width: 100%; max-height: 100%; display: block;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="applyCropBtn">
                        <i class="bi bi-check2"></i> Apply Crop
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Load image into cropper
    const reader = new FileReader();
    reader.onload = function(e) {
        const cropperImage = document.getElementById('cropperImage');
        cropperImage.src = e.target.result;

        // Initialize Cropper
        cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 0.9,
            responsive: true,
            restore: false,
            guides: true,
            center: true,
            highlight: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: true,
            minContainerWidth: 600,
            minContainerHeight: 600,
        });
    };
    reader.readAsDataURL(file);

    // Apply Crop Button
    document.getElementById('applyCropBtn').addEventListener('click', function() {
        if (!cropper) return;

        cropper.getCroppedCanvas({
            width: 800,
            height: 800,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        }).toBlob(function(blob) {
            // Replace the image with cropped version
            const croppedFile = new File([blob], file.name, { 
                type: 'image/jpeg',
                lastModified: Date.now()
            });
            selectedImages[index] = croppedFile;
            
            // Destroy cropper and close modal
            cropper.destroy();
            cropper = null;
            bsModal.hide();
            
            // Refresh thumbnails
            displayImageThumbnails();
        }, 'image/jpeg', 0.9);
    });

    // Cleanup on modal close
    modal.addEventListener('hidden.bs.modal', function() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        modal.remove();
    });
}

// Form Validation
function validateForm() {
    let isValid = true;
    clearErrors();

    // Validate Product Name
    const productName = document.querySelector('[name="productName"]').value.trim();
    if (!productName) {
        showError('error-productName', 'Product name is required');
        isValid = false;
    } else if (productName.length < 3) {
        showError('error-productName', 'Product name must be at least 3 characters');
        isValid = false;
    }

    // Validate Description
    const description = document.querySelector('[name="description"]').value.trim();
    if (!description) {
        showError('error-description', 'Description is required');
        isValid = false;
    } else if (description.length < 10) {
        showError('error-description', 'Description must be at least 10 characters');
        isValid = false;
    }

    // Validate Category
    const category = document.querySelector('[name="category"]').value;
    if (!category) {
        showError('error-category', 'Category is required');
        isValid = false;
    }

    // Validate Variants
    const variantNames = document.querySelectorAll('[name="variantName[]"]');
    const variantPrices = document.querySelectorAll('[name="variantPrice[]"]');
    const variantStocks = document.querySelectorAll('[name="variantStock[]"]');

    if (variantNames.length === 0) {
        showError('variant-main-error', 'At least one variant is required');
        isValid = false;
    }

    variantNames.forEach((input, index) => {
        const name = input.value.trim();
        const price = variantPrices[index].value;
        const quantity = variantStocks[index].value;

        if (!name) {
            input.nextElementSibling.textContent = 'Variant name required';
            isValid = false;
        }
        if (!price || price <= 0) {
            variantPrices[index].nextElementSibling.textContent = 'Valid price required';
            isValid = false;
        }
        if (!quantity || quantity < 0) {
            variantStocks[index].nextElementSibling.textContent = 'Valid stock required';
            isValid = false;
        }
    });


    if (!selectedImages || selectedImages.length === 0) {
        showError('imageError', 'Please select product images');
        isValid = false;
    } else if (selectedImages.length < 3) {
        showError('imageError', 'At least 3 images are required');
        isValid = false;
    } else {
        // Validate file types and sizes
        for (let i = 0; i < selectedImages.length; i++) {
            const file = selectedImages[i];
            if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/jpg')) {
                showError('imageError', 'Only PNG, JPG, JPEG files are allowed');
                isValid = false;
                break;
            }
            if (file.size > 2 * 1024 * 1024) {
                showError('imageError', 'Each image must be less than 2MB');
                isValid = false;
                break;
            }
        }
    }

    if (isValid) {
        submitForm();
    } else {
        // Scroll to first error
        const firstError = document.querySelector('.text-danger:not(:empty)');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Submit Form with Axios
async function submitForm() {
  const formData = new FormData();

  const submitBtn = document.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

  // Basic fields
  formData.append('productName', document.querySelector('[name="productName"]').value.trim());
  formData.append('description', document.querySelector('[name="description"]').value.trim());
  formData.append('category', document.querySelector('[name="category"]').value);
  formData.append('status', document.querySelector('[name="status"]').value);
  formData.append('featured', document.querySelector('[name="featured"]').checked);

  // Variants
  const variantNames = document.querySelectorAll('[name="variantName[]"]');
  const variantPrices = document.querySelectorAll('[name="variantPrice[]"]');
  const variantStocks = document.querySelectorAll('[name="variantStock[]"]');

  const variants = [];
  variantNames.forEach((input, index) => {
    variants.push({
      size: input.value.trim(),
      price: parseFloat(variantPrices[index].value),
      quantity: parseInt(variantStocks[index].value)
    });
  });
  formData.append('variants', JSON.stringify(variants));

  // Images
  selectedImages.forEach((img) => {
    if (img) {
      formData.append('images', img);
    }
  });

  try {
    const response = await axios.post('/admin/products/add', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });

    if (response.data.success) {
      showToast('success', response.data.message || 'Product added successfully');

      setTimeout(() => {
        window.location.href = '/admin/products';
      }, 800);
    } else {
      showToast('error', response.data.message || 'Failed to add product');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  } catch (error) {
    console.error('Error:', error);
    const msg = error.response?.data?.message || 'An error occurred while adding the product';
    showToast('error', msg);
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
}


function showError(id, message) {
    const errorElement = document.getElementById(id);
    if (errorElement) {
        errorElement.textContent = message;
    }
}

function clearError(id) {
    const errorElement = document.getElementById(id);
    if (errorElement) {
        errorElement.textContent = '';
    }
}

function clearErrors() {
    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
    document.querySelectorAll('.variant-error').forEach(el => el.textContent = '');
}
</script>


